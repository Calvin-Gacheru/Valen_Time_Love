<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine's Quiz</title>
    <style>
        /* CSS: The Visuals */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* The Container */
        .phone-container {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            width: 90%; 
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            position: relative;
        }

        /* Password Gate Styles */
        #password-gate { 
            text-align: center; 
            color: white; 
        }

        input[type="password"] { 
            padding: 10px; 
            border-radius: 5px; 
            border: none; 
            margin-bottom: 10px; 
            width: 80%; 
        }

        button.unlock-btn { 
            background: #ff4b4b; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1em;
        }

        /* Quiz UI */
        .score-board { 
            background: #fff; 
            color: #6a11cb; 
            padding: 10px; 
            border-radius: 10px; 
            text-align: center; 
            font-weight: bold; 
            margin-bottom: 15px; 
        }
        .card { background: #fff; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        #quiz-container { display: none; flex-direction: column; }
        .question-text { font-size: 1.1em; margin-bottom: 20px; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .option-btn { background: #f0f0f0; border: 1px solid #ddd; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; }
        .option-btn:hover { background: #e0e0e0; }

        /* Proposal Styles */
        #proposal-container { display: none; flex-direction: column; }
        .btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .yes-btn { background-color: #32cd32; color: white; padding: 10px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em; }
        .no-btn { background-color: #ff3b3b; color: white; padding: 10px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1em; }

        /* Success Styles */
        #success-container { display: none; flex-direction: column; }

        /* Error Popups */
        .overlay-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
            display: none;
            z-index: 100;
            width: 80%;
            max-width: 300px;
        }
        .heart-popup { font-size: 50px; color: red; animation: pop 0.6s ease-out, float-heart 1.6s ease-in-out infinite; }
        .hurt-popup { font-size: 50px; animation: shake 0.6s ease-in-out, wobble 1.2s ease-in-out; }

        #system-error-overlay {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            color: #ff4b4b;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ff4b4b;
            text-align: center;
            display: none;
            z-index: 200;
            width: 85%;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @keyframes pop { 0% { transform: scale(0); } 70% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-6px); } 50% { transform: translateX(6px); } 75% { transform: translateX(-6px); } 100% { transform: translateX(0); } }
        @keyframes float-heart { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-6px); } }
        @keyframes wobble { 0% { transform: rotate(0deg); } 25% { transform: rotate(-6deg); } 50% { transform: rotate(6deg); } 75% { transform: rotate(-4deg); } 100% { transform: rotate(0deg); } }
        @keyframes heartbeat { 0% { transform: scale(1); } 15% { transform: scale(1.05); } 30% { transform: scale(1); } 45% { transform: scale(1.05); } 60% { transform: scale(1); } 100% { transform: scale(1); } }

        #success-container .card { animation: heartbeat 1.5s infinite; }

        /* Heart Confetti */
        #heart-confetti {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 300;
        }
        .confetti-heart {
            position: absolute;
            top: -10%;
            font-size: 22px;
            opacity: 0.9;
            animation: fall-heart 6s linear forwards;
            text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        @keyframes fall-heart {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="music-player" style="position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none;"></div>

    <div class="phone-container">

        <div id="password-gate">
            <h2>üîí Top Secret Love</h2>
            <p>Enter the password to start.</p>
            <input type="password" id="password-input" placeholder="Enter Password">
            <br>
            <button class="unlock-btn" onclick="checkPassword()">Unlock</button>
            <p id="error-msg" style="color: #ff6b6b; font-size: 0.8em; display: none;">Wrong password!</p>
        </div>

        <div id="quiz-container">
            <div class="score-board">Score: <span id="score-val">0</span>/<span id="total-questions">4</span></div>
            <div class="card">
                <img id="question-image" style="display:none; max-width:100%; border-radius:10px; margin-bottom:15px; margin-left: auto; margin-right: auto;" src="" />
                
                <div class="question-text" id="question-text">Loading...</div>
                <div class="options" id="options-container"></div>
            </div>
        </div>

        <div id="proposal-container">
            <div class="score-board">Score: <span id="proposal-score-val">0</span>/<span id="total-score">4</span></div> 
            <div class="card">
                <h2 style="margin-bottom: 20px;">Will you be my Valentine?</h2>
                <div class="btn-group">
                    <button class="yes-btn" onclick="handleProposal('yes')">Yes ‚ù§Ô∏è</button>
                    <button class="no-btn" onclick="handleProposal('no')">No</button>
                </div>
            </div>
        </div>

        <div id="success-container">
            <div class="score-board">‚ù§Ô∏è LOVE CONFIRMED ‚ù§Ô∏è</div>
            <div class="card">
                <h2>üéâ Yay! You're My Valentine! üéâ</h2>
                <p style="font-size: 40px; margin: 10px 0;">ü•Çü•∞</p>
                <p style="font-weight: bold; color: #555;">Thank you for making my day special! ‚ù§Ô∏è</p>
            </div>
        </div>

        <div id="system-error-overlay">
            <div style="font-size: 1.2em; margin-bottom: 5px;">‚ùå Invalid choice.</div>
            <div style="font-size: 0.9em; color: white;">System has detected you are already my Valentine.</div>
        </div>

    </div>

    <div id="heart-overlay" class="overlay-msg">
        <div class="heart-popup" id="success-icon">‚ù§Ô∏è</div>
        <h3 id="success-text">Correct!</h3>
    </div>

    <div id="hurt-overlay" class="overlay-msg">
        <div class="hurt-popup">üíî</div>
        <h3 id="fail-text">You hurt my feelings</h3>
    </div>

    <div id="heart-confetti"></div>
    
    <script>
        // --- GLOBAL VARIABLES ---
        let CORRECT_PASSWORD = "123"; 
        let MUSIC_ID = ""; 
        let player; 
        
        // Default Fallback Questions
        let questions = [
            {
                question: "When did I first fall for you?",
                options: ["Jan 29", "Feb 12", "Jan 28", "I Don't Remember"],
                correct: 0,
                failMsg: "You hurt my feelings ü•∫",
                successEmoji: "üíò",
                successMsg: "Aww, you remember! ü•∞"
            }
        ];

        let currentScore = 0;
        let currentQuestionIndex = 0;

        // --- 1. STARTUP SEQUENCE ---
        window.onload = function() {
            // A. Decode the URL
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (encodedData) {
                try {
                    const decodedJson = decodeURIComponent(escape(atob(encodedData)));
                    const customConfig = JSON.parse(decodedJson);

                    if(customConfig.password) CORRECT_PASSWORD = customConfig.password;
                    if(customConfig.questions) questions = customConfig.questions;
                    
                    // LOAD MUSIC ID
                    if(customConfig.musicId) {
                        MUSIC_ID = customConfig.musicId;
                        console.log("Music ID Found:", MUSIC_ID);
                        // NOW load the YouTube Script (Only after we have the ID)
                        loadYoutubeScript();
                    }
                    
                } catch (e) {
                    console.error("Error loading data", e);
                }
            }
            
            // B. Update UI
            document.getElementById('total-questions').textContent = questions.length;
            document.getElementById('total-score').textContent = questions.length;
        };

        // --- 2. YOUTUBE LOGIC ---
        function loadYoutubeScript() {
            var tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            var firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // This function runs automatically when YouTube API is ready
        function onYouTubeIframeAPIReady() {
            if(MUSIC_ID) {
                player = new YT.Player('music-player', {
                    height: '1',
                    width: '1',
                    videoId: MUSIC_ID,
                    playerVars: {
                        'autoplay': 0, 
                        'controls': 0, 
                        'loop': 1, 
                        'playlist': MUSIC_ID, // Needed for loop to work
                        'playsinline': 1,
                        'enablejsapi': 1,
                        'origin': window.location.origin
                    },
                    events: {
                        'onReady': function(event) {
                            console.log("Player is ready!");
                            // Option to lower volume
                            event.target.setVolume(50);
                        },
                        'onError': function(e) {
                            console.error("Error loading YouTube video:", e.data);
                        }
                    }
                });
            }
        }

        // --- 3. QUIZ LOGIC ---
        function checkPassword() {
            const input = document.getElementById('password-input').value;
            if(input === CORRECT_PASSWORD) {
                document.getElementById('password-gate').style.display = 'none';
                
                // TRIGGER MUSIC HERE
                if(player && typeof player.playVideo === 'function') {
                    player.playVideo();
                    player.setVolume(50);
                    console.log("Playing Music...");
                } else {
                    console.log("Player not ready yet.");
                }

                document.getElementById('quiz-container').style.display = 'flex';
                loadQuestion();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                document.getElementById('quiz-container').style.display = 'none';
                document.getElementById('proposal-score-val').textContent = currentScore;
                document.getElementById('proposal-container').style.display = 'flex';
                return;
            }

            const q = questions[currentQuestionIndex];
            document.getElementById('question-text').textContent = q.question;

            // Handle Image
            const imgEl = document.getElementById('question-image');
            if (q.imgUrl && q.imgUrl.trim() !== "") {
                imgEl.src = q.imgUrl;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            const optionsDiv = document.getElementById('options-container');
            optionsDiv.innerHTML = ''; 

            q.options.forEach((opt, index) => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = opt;
                btn.onclick = () => handleAnswer(index);
                optionsDiv.appendChild(btn);
            });
        }

        function handleAnswer(selectedIndex) {
            const q = questions[currentQuestionIndex];
            const isCorrect = (q.correct === -1) || (selectedIndex === q.correct);

            if (isCorrect) {
                currentScore++;
                document.getElementById('score-val').textContent = currentScore;
                
                const successText = q.successMsg || "Correct!";
                document.getElementById('success-text').textContent = successText;

                const successEmoji = q.successEmoji || "‚ù§Ô∏è";
                document.getElementById('success-icon').textContent = successEmoji;
                showFeedback('heart-overlay');
            } else {
                document.getElementById('fail-text').textContent = q.failMsg;
                showFeedback('hurt-overlay');
            }
        }

        function showFeedback(elementId) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            setTimeout(() => {
                el.style.display = 'none';
                currentQuestionIndex++;
                loadQuestion();
            }, 2000); 
        }

        function handleProposal(answer) {
            if (answer === 'yes') {
                document.getElementById('proposal-container').style.display = 'none';
                document.getElementById('success-container').style.display = 'flex';
                launchHeartConfetti();
            } else {
                const errorPopup = document.getElementById('system-error-overlay');
                errorPopup.style.display = 'block';
                setTimeout(() => {
                    errorPopup.style.display = 'none';
                }, 3000);
            }
        }

        function launchHeartConfetti() {
            const confetti = document.getElementById('heart-confetti');
            const count = 25; 
            const burstIntervalMs = 350;
            const hearts = ['‚ù§Ô∏è', 'üíñ', 'üíò', 'üíï', 'üåπ', 'ü•Ä', 'üå∫', 'üåª', 'üåº', 'üå∑', 'üíê'];

            function spawnHeart(i) {
                const heart = document.createElement('div');
                heart.className = 'confetti-heart';
                heart.textContent = hearts[i % hearts.length];
                heart.style.left = Math.random() * 100 + '%';
                heart.style.animationDelay = (Math.random() * 0.8).toFixed(2) + 's';
                heart.style.animationDuration = (5 + Math.random() * 3).toFixed(2) + 's';
                heart.style.fontSize = (18 + Math.random() * 16) + 'px';
                confetti.appendChild(heart);

                setTimeout(() => { heart.remove(); }, 9000);
            }

            for (let i = 0; i < count; i++) spawnHeart(i);

            let i = count;
            const intervalId = setInterval(() => {
                spawnHeart(i);
                i += 1;
            }, burstIntervalMs);

            setTimeout(() => { clearInterval(intervalId); }, 12000);
        }
    </script>
</body>
</html>